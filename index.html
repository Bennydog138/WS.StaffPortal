<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellfield Staff Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-accepted { background-color: #dcfce7; color: #166534; }
        .status-denied { background-color: #fee2e2; color: #991b1b; }
        .nav-btn.active-tab { background-color: #0f172a; color: white; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Login Screen -->
        <div id="login-screen" class="flex-grow flex items-center justify-center p-4">
            <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100">
                <div class="text-center mb-8">
                    <img src="https://cdn.discordapp.com/attachments/1450890580367380564/1457484530934878430/image.png?ex=695c2bbe&is=695ada3e&hm=d55476b0890e63694ff1c7fa4bab30a5dcc6649826c93752777f424c74f098dd&" alt="Logo" class="w-24 h-24 mx-auto mb-6 object-contain">
                    <h1 class="text-3xl font-bold text-slate-900">Staff Portal</h1>
                    <p class="text-slate-500 mt-2">Wellfield Management Systems</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="username" required placeholder="Username" class="w-full p-4 rounded-2xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="password" id="password" required placeholder="Password" class="w-full p-4 rounded-2xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="submit" id="login-btn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition-all">Sign In</button>
                </form>
                <p class="mt-6 text-center text-xs text-slate-400">admin / setup123</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden flex-grow flex flex-col">
            <nav class="glass-nav border-b border-slate-200 px-8 py-4 flex items-center justify-between sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <img src="https://cdn.discordapp.com/attachments/1450890580367380564/1457484530934878430/image.png?ex=695c2bbe&is=695ada3e&hm=d55476b0890e63694ff1c7fa4bab30a5dcc6649826c93752777f424c74f098dd&" alt="Logo" class="w-10 h-10 object-contain">
                    <div>
                        <h2 class="font-bold text-slate-900 leading-none">Wellfield Staff</h2>
                        <span id="role-badge" class="text-[10px] font-black uppercase tracking-widest text-blue-600">Staff Member</span>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <span id="display-name" class="font-bold text-sm text-slate-600"></span>
                    <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-bold">LOGOUT</button>
                </div>
            </nav>

            <div class="flex flex-grow overflow-hidden">
                <aside class="w-64 bg-white border-r border-slate-200 p-6 flex flex-col gap-2 overflow-y-auto">
                    <button onclick="switchTab('notices')" class="nav-btn active-tab flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="notices">
                        <i class="fas fa-bullhorn"></i> Notices
                    </button>
                    <button onclick="switchTab('requests')" class="nav-btn flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="requests">
                        <i class="fas fa-calendar-alt"></i> Absences/LOA
                    </button>
                    <button onclick="switchTab('my-stats')" class="nav-btn flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="my-stats">
                        <i class="fas fa-chart-bar"></i> My Records
                    </button>
                    
                    <div id="admin-menu" class="hidden mt-6 pt-6 border-t border-slate-100 space-y-2">
                        <p class="text-[10px] font-black text-slate-400 uppercase px-4 mb-2">Admin Tools</p>
                        <button onclick="switchTab('attendance')" class="nav-btn w-full flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="attendance">
                            <i class="fas fa-clipboard-user"></i> Session Attendance
                        </button>
                        <button onclick="switchTab('admin-requests')" class="nav-btn w-full flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="admin-requests">
                            <i class="fas fa-envelope-open-text"></i> Pending Requests
                        </button>
                        <button onclick="switchTab('manage-staff')" class="nav-btn w-full flex items-center gap-3 p-4 rounded-xl font-bold transition-all text-slate-600 hover:bg-slate-50" data-tab="manage-staff">
                            <i class="fas fa-user-gear"></i> Manage Staff
                        </button>
                    </div>
                </aside>

                <main class="flex-grow p-8 overflow-y-auto custom-scrollbar">
                    <div id="tab-notices" class="tab-content space-y-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold">Important Notices</h1>
                            <button id="btn-add-notice" onclick="openNoticeModal()" class="hidden bg-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold">Post Notice</button>
                        </div>
                        <div id="notices-list" class="grid grid-cols-1 gap-4"></div>
                    </div>

                    <div id="tab-requests" class="tab-content hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold">My Absence Requests</h1>
                            <div class="flex gap-2">
                                <button onclick="openRequestModal('LOA')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold">Request LOA</button>
                                <button onclick="openRequestModal('Absence')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold">Session Absence</button>
                            </div>
                        </div>
                        <div id="my-requests-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <div id="tab-my-stats" class="tab-content hidden space-y-6">
                        <h1 class="text-2xl font-bold">Attendance & Strikes</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm col-span-2">
                                <h2 class="font-bold mb-4">Strike History</h2>
                                <div id="my-strikes" class="space-y-3"></div>
                            </div>
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm text-center">
                                <h2 class="font-bold mb-2">Attendance Summary</h2>
                                <div id="my-attendance-rating" class="text-5xl font-black text-blue-600 my-4">--%</div>
                                <p class="text-xs text-slate-400">Current Rating</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-attendance" class="tab-content hidden space-y-6">
                        <h1 class="text-2xl font-bold">Session Attendance</h1>
                        <div class="bg-white p-8 rounded-3xl border border-slate-200">
                            <div class="flex gap-4 mb-6">
                                <input type="date" id="attendance-date" class="border rounded-xl px-4 py-2 outline-none">
                                <input type="text" id="attendance-session-name" placeholder="Session Name (e.g. Afternoon Shift)" class="flex-grow border rounded-xl px-4 py-2 outline-none">
                            </div>
                            <div id="attendance-roster" class="divide-y divide-slate-100"></div>
                            <button onclick="submitAttendance()" class="mt-8 w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">Submit Attendance</button>
                        </div>
                    </div>

                    <div id="tab-admin-requests" class="tab-content hidden space-y-6">
                        <h1 class="text-2xl font-bold">Manage Requests</h1>
                        <div id="admin-requests-list" class="grid grid-cols-1 gap-4"></div>
                    </div>

                    <div id="tab-manage-staff" class="tab-content hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold">Staff Directory</h1>
                            <button onclick="openStaffModal()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold">Add Staff</button>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 border-b">
                                    <tr>
                                        <th class="p-4">Staff Member</th>
                                        <th class="p-4">Discord / Roblox</th>
                                        <th class="p-4">Strikes</th>
                                        <th class="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="staff-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl relative z-10 p-8 max-h-[90vh] overflow-y-auto"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, arrayUnion, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDpt6nXzvsd87KE4yWGgQh3uyBI5LTjDYI",
            authDomain: "wellfieldschoolwebsitestaff.firebaseapp.com",
            projectId: "wellfieldschoolwebsitestaff",
            storageBucket: "wellfieldschoolwebsitestaff.firebasestorage.app",
            messagingSenderId: "366345454956",
            appId: "1:366345454956:web:55a3a290ba9f2867895f49"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wellfield-staff-portal';

        let currentUser = null;
        let staffList = [];
        let globalRequests = [];
        let attendanceLogs = [];
        let authReady = false;
        let currentAuthUser = null;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentAuthUser = user;
                authReady = true;
                const session = localStorage.getItem('wf_staff_session');
                if (session) applySession(JSON.parse(session));
            }
        });

        function applySession(session) {
            currentUser = session;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('display-name').innerText = session.username;
            document.getElementById('role-badge').innerText = session.role === 'admin' ? 'Administrator' : 'Staff Member';
            if (session.role === 'admin') {
                document.getElementById('admin-menu').classList.remove('hidden');
                document.getElementById('btn-add-notice').classList.remove('hidden');
            }
            startListeners();
        }

        function startListeners() {
            if (!currentAuthUser || !currentUser) return;

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'notices'), (snap) => {
                const list = document.getElementById('notices-list');
                if(!list) return;
                list.innerHTML = '';
                snap.docs.forEach(d => {
                    const n = d.data();
                    list.innerHTML += `
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative">
                            ${currentUser.role === 'admin' ? `<button onclick="deleteDocById('notices', '${d.id}')" class="absolute top-4 right-4 text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-black uppercase">ADMIN NOTICE</span>
                                <span class="text-[10px] text-slate-400 font-bold">${n.date}</span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900">${n.title}</h3>
                            <p class="text-sm text-slate-600 mt-2 whitespace-pre-wrap">${n.content}</p>
                            <div class="mt-4 pt-4 border-t border-slate-50 text-[10px] font-bold text-slate-400">POSTED BY ${n.author.toUpperCase()}</div>
                        </div>`;
                });
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                globalRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderRequests();
                if (currentUser.role === 'admin') renderRoster();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                staffList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderStaffDirectory();
                if (currentUser.role === 'admin') renderRoster();
                updateMyStats();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance_logs'), (snap) => {
                attendanceLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateMyStats();
            });
        }

        function renderRequests() {
            const myList = document.getElementById('my-requests-list');
            const adminList = document.getElementById('admin-requests-list');
            if(!myList || !adminList || !currentUser) return;
            myList.innerHTML = '';
            adminList.innerHTML = '';
            globalRequests.forEach(r => {
                const card = `
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-[10px] font-black uppercase ${r.type === 'LOA' ? 'text-blue-600' : 'text-slate-600'}">${r.type} REQUEST</span>
                                <h4 class="font-bold">${r.staffName}</h4>
                            </div>
                            <span class="px-2 py-1 rounded text-[10px] font-black uppercase status-${r.status}">${r.status}</span>
                        </div>
                        <div class="text-xs space-y-1 mb-4">
                            <p><b>Date:</b> ${r.date}</p>
                            <p><b>Reason:</b> ${r.reason}</p>
                            ${r.adminReason ? `<p class="mt-2 p-2 bg-slate-50 border rounded-lg italic"><b>Admin Note:</b> ${r.adminReason}</p>` : ''}
                        </div>
                        ${currentUser.role === 'admin' && r.status === 'pending' ? `
                            <div class="flex gap-2">
                                <button onclick="handleRequest('${r.id}', 'accepted')" class="flex-grow bg-green-600 text-white text-xs font-bold py-2 rounded-lg">Accept</button>
                                <button onclick="handleRequest('${r.id}', 'denied')" class="flex-grow bg-red-600 text-white text-xs font-bold py-2 rounded-lg">Deny</button>
                            </div>` : ''}
                    </div>`;
                if (r.staffId === currentUser.uid) myList.innerHTML += card;
                if (r.status === 'pending') adminList.innerHTML += card;
            });
        }

        function renderRoster() {
            const roster = document.getElementById('attendance-roster');
            if (!roster) return;
            roster.innerHTML = '';
            const selectedDate = document.getElementById('attendance-date').value;
            staffList.forEach(s => {
                if (s.role === 'admin') return;
                const approvedAbsence = globalRequests.find(r => r.staffId === s.id && r.status === 'accepted' && r.date === selectedDate);
                const div = document.createElement('div');
                div.className = `py-4 flex flex-col md:flex-row md:items-center justify-between gap-4 ${approvedAbsence ? 'opacity-50 grayscale bg-slate-50' : ''}`;
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-slate-900">${s.username} <span class="text-[10px] text-slate-400">(${s.firstName} ${s.lastName})</span></p>
                        ${approvedAbsence ? `<span class="text-[10px] text-orange-600 font-bold italic">PRE-APPROVED: ${approvedAbsence.reason}</span>` : ''}
                    </div>
                    <div class="flex gap-4 items-center">
                        <label class="flex items-center gap-1"><input type="radio" name="att-${s.id}" value="P" ${approvedAbsence ? 'disabled' : 'checked'}> <span class="text-xs font-bold">P</span></label>
                        <label class="flex items-center gap-1"><input type="radio" name="att-${s.id}" value="L" ${approvedAbsence ? 'disabled' : ''}> <span class="text-xs font-bold">L</span></label>
                        <label class="flex items-center gap-1"><input type="radio" name="att-${s.id}" value="A" ${approvedAbsence ? 'disabled checked' : ''}> <span class="text-xs font-bold">A</span></label>
                        <input type="text" placeholder="Reason (if absent)" id="reason-${s.id}" class="text-xs border rounded-lg p-2 w-48 outline-none">
                    </div>`;
                roster.appendChild(div);
            });
        }

        function renderStaffDirectory() {
            const body = document.getElementById('staff-table-body');
            if (!body) return;
            body.innerHTML = '';
            staffList.forEach(s => {
                if (s.role === 'admin' && s.id === 'initial-admin') return;
                const row = document.createElement('tr');
                row.className = "border-b border-slate-50 hover:bg-slate-50/50 cursor-pointer transition-colors";
                row.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    viewStaffProfile(s.id);
                };
                row.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-700">${s.title || ''} ${s.firstName || s.username} ${s.lastName || ''}</div>
                        <div class="text-[10px] uppercase font-black tracking-wider text-slate-400">${s.role} / Login: ${s.username}</div>
                    </td>
                    <td class="p-4">
                        <div class="text-sm font-medium text-slate-600 flex items-center gap-2"><i class="fab fa-discord text-indigo-500"></i> ${s.discord || 'N/A'}</div>
                        <div class="text-[10px] text-slate-400 flex items-center gap-2"><i class="fas fa-gamepad"></i> ${s.roblox || 'N/A'}</div>
                    </td>
                    <td class="p-4"><span class="bg-red-50 text-red-600 px-2 py-1 rounded font-black text-xs">${(s.strikes || []).length}</span></td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="openStrikeModal('${s.id}', '${s.username}')" class="bg-red-50 text-red-600 p-2 rounded-lg hover:bg-red-100 transition-colors" title="Issue Strike"><i class="fas fa-gavel"></i></button>
                            <button onclick="deleteDocById('users', '${s.id}')" class="bg-slate-100 text-slate-400 p-2 rounded-lg hover:text-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>`;
                body.appendChild(row);
            });
        }

        window.viewStaffProfile = (id) => {
            const s = staffList.find(x => x.id === id);
            if (!s) return;
            const history = attendanceLogs.filter(l => l.staffId === id);
            const present = history.filter(h => h.status === 'P').length;
            const rating = history.length ? Math.round((present / history.length) * 100) : 100;

            showModal(`
                <div class="space-y-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">${s.title || ''} ${s.firstName} ${s.lastName}</h2>
                            <p class="text-sm text-blue-600 font-bold uppercase tracking-widest">${s.role} Portal Access</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black text-blue-600">${rating}%</div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Attendance Rating</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Internal Credentials</p>
                            <p class="text-sm font-bold">Username: <span class="text-slate-600 font-normal">${s.username}</span></p>
                            <p class="text-sm font-bold">Password: <span class="text-slate-600 font-normal">${s.password}</span></p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Linked Socials</p>
                            <p class="text-sm font-bold">Discord: <span class="text-indigo-600 font-normal">${s.discord || 'Not linked'}</span></p>
                            <p class="text-sm font-bold">Roblox: <span class="text-slate-600 font-normal">${s.roblox || 'Not linked'}</span></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold border-b pb-2 mb-4">Strike Records</h3>
                        <div class="space-y-2">
                            ${(s.strikes || []).length ? s.strikes.map(st => `
                                <div class="p-3 bg-red-50 border border-red-100 rounded-xl flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-bold text-red-900">${st.reason}</p>
                                        <p class="text-[10px] text-red-400 font-bold">Issued by: ${st.issuer || 'System'}</p>
                                    </div>
                                    <span class="text-[10px] font-bold text-red-400">${st.date}</span>
                                </div>
                            `).join('') : '<p class="text-xs text-slate-400 italic">No strikes recorded.</p>'}
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold border-b pb-2 mb-4">Attendance History</h3>
                        <div class="max-h-48 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                            ${history.length ? history.sort((a,b) => new Date(b.date) - new Date(a.date)).map(l => `
                                <div class="flex items-center justify-between p-2 border-b text-xs">
                                    <div class="flex items-center gap-3">
                                        <span class="w-6 h-6 rounded flex items-center justify-center font-bold ${l.status === 'P' ? 'bg-green-100 text-green-700' : l.status === 'L' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${l.status}</span>
                                        <div>
                                            <p class="font-bold">${l.session}</p>
                                            <p class="text-[10px] text-slate-400">${l.date}</p>
                                        </div>
                                    </div>
                                    ${l.reason ? `<span class="text-[10px] italic text-slate-500">${l.reason}</span>` : ''}
                                </div>
                            `).join('') : '<p class="text-xs text-slate-400 italic">No session history found.</p>'}
                        </div>
                    </div>
                </div>
            `);
        };

        function updateMyStats() {
            if (!currentUser) return;
            const user = staffList.find(s => s.id === currentUser.uid);
            if (!user) return;
            const strikeList = document.getElementById('my-strikes');
            if(strikeList) {
                strikeList.innerHTML = user.strikes?.length ? '' : '<p class="text-sm text-slate-400 italic">No strikes recorded.</p>';
                (user.strikes || []).forEach(st => {
                    strikeList.innerHTML += `
                        <div class="p-4 bg-red-50 border border-red-100 rounded-xl">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-black text-red-600 uppercase">OFFENSE</span>
                                <span class="text-[10px] text-slate-400 font-bold">${st.date}</span>
                            </div>
                            <p class="text-sm text-slate-700"><b>Reason:</b> ${st.reason}</p>
                            <p class="text-[10px] mt-2 text-red-400 font-bold uppercase">ISSUED BY ${st.issuer || 'System'}</p>
                        </div>`;
                });
            }
            const myHistory = attendanceLogs.filter(l => l.staffId === currentUser.uid);
            const presentCount = myHistory.filter(h => h.status === 'P').length;
            const rating = myHistory.length ? Math.round((presentCount / myHistory.length) * 100) : 100;
            const ratingDiv = document.getElementById('my-attendance-rating');
            if(ratingDiv) ratingDiv.innerText = `${rating}%`;
        }

        window.handleRequest = async (id, status) => {
            if (!currentAuthUser) return;
            const adminReason = status === 'denied' ? prompt("Denial reason:") : "";
            if (status === 'denied' && !adminReason) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id), {
                status, adminReason, handledBy: currentUser.username
            });
        };

        window.submitAttendance = async () => {
            if (!currentAuthUser) return;
            const date = document.getElementById('attendance-date').value;
            const session = document.getElementById('attendance-session-name').value;
            if (!date || !session) return alert("Date and Session name required");
            for (const s of staffList) {
                if (s.role === 'admin') continue;
                const statusInput = document.querySelector(`input[name="att-${s.id}"]:checked`);
                if(!statusInput) continue;
                const status = statusInput.value;
                const reason = document.getElementById(`reason-${s.id}`).value;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance_logs'), {
                    staffId: s.id, status, reason, date, session
                });
            }
            alert("Attendance Logged Successfully");
            document.getElementById('attendance-session-name').value = '';
        };

        window.deleteDocById = async (col, id) => { 
            if (!currentAuthUser) return;
            if (confirm(`Confirm deletion of this ${col === 'users' ? 'staff member' : 'item'}? This cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                    if(col === 'users') closeModal();
                } catch (error) {
                    alert("Delete failed. Permission error.");
                }
            }
        };

        window.openNoticeModal = () => {
            showModal(`<h2 class="text-xl font-bold mb-4">Post Notice</h2>
                <input type="text" id="n-title" placeholder="Title" class="w-full border p-4 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                <textarea id="n-content" placeholder="Type announcement content here..." class="w-full border p-4 rounded-xl mb-4 h-32 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                <button onclick="saveNotice()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Publish Notice</button>`);
        };
        window.saveNotice = async () => {
            if (!currentAuthUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notices'), {
                title: document.getElementById('n-title').value, content: document.getElementById('n-content').value,
                date: new Date().toLocaleDateString(), author: currentUser.username
            });
            closeModal();
        };

        window.openRequestModal = (type) => {
            showModal(`<h2 class="text-xl font-bold mb-4">New ${type} Request</h2>
                <input type="date" id="r-date" class="w-full border p-4 rounded-xl mb-4">
                <textarea id="r-reason" placeholder="Explain why you need this absence..." class="w-full border p-4 rounded-xl mb-4 h-24 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                <button onclick="saveRequest('${type}')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Submit Request</button>`);
        };
        window.saveRequest = async (type) => {
            if (!currentAuthUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                type, date: document.getElementById('r-date').value, reason: document.getElementById('r-reason').value,
                staffId: currentUser.uid, staffName: currentUser.username, status: 'pending', adminReason: ''
            });
            closeModal();
        };

        window.openStrikeModal = (id, name) => {
            showModal(`<h2 class="text-xl font-bold mb-2">Issue Strike</h2><p class="text-sm text-slate-500 mb-4">Recipient: ${name}</p>
                <textarea id="st-reason" placeholder="Reason for strike..." class="w-full border p-4 rounded-xl mb-4 h-24 focus:ring-2 focus:ring-red-500 outline-none"></textarea>
                <button onclick="saveStrike('${id}')" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold">Submit Strike</button>`);
        };
        window.saveStrike = async (id) => {
            if (!currentAuthUser) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                strikes: arrayUnion({ 
                    reason: document.getElementById('st-reason').value, 
                    date: new Date().toLocaleDateString(),
                    issuer: currentUser.username 
                })
            });
            closeModal();
        };

        window.openStaffModal = () => {
            showModal(`
                <h2 class="text-xl font-bold mb-4">Onboard New Staff</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Title</label>
                        <select id="u-title" class="w-full border p-3 rounded-xl mb-4 bg-white"><option>Mr</option><option>Mrs</option><option>Miss</option><option>Ms</option><option>Mx</option><option>Dr</option><option>Prof</option></select>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Portal Role</label>
                        <select id="u-role" class="w-full border p-3 rounded-xl mb-4 bg-white"><option value="staff">Standard Staff</option><option value="admin">Administrator</option></select>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">First Name</label>
                        <input type="text" id="u-fname" placeholder="John" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Last Name</label>
                        <input type="text" id="u-lname" placeholder="Doe" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Discord Username</label>
                        <input type="text" id="u-disc" placeholder="john.doe" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Roblox Username</label>
                        <input type="text" id="u-robx" placeholder="RobloxPlayer123" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                    <div class="col-span-2 border-t pt-4">
                        <p class="text-[10px] font-black uppercase text-blue-600 mb-2">Portal Access Credentials</p>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Website Username</label>
                        <input type="text" id="u-user" placeholder="j.doe" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Website Password</label>
                        <input type="password" id="u-pass" placeholder="••••••••" class="w-full border p-3 rounded-xl mb-4">
                    </div>
                </div>
                <button onclick="saveStaff()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold mt-4 shadow-lg shadow-slate-200">Create Staff Profile</button>`);
        };
        window.saveStaff = async () => {
            if (!currentAuthUser) return;
            const data = {
                title: document.getElementById('u-title').value,
                firstName: document.getElementById('u-fname').value,
                lastName: document.getElementById('u-lname').value,
                discord: document.getElementById('u-disc').value,
                roblox: document.getElementById('u-robx').value,
                username: document.getElementById('u-user').value,
                password: document.getElementById('u-pass').value,
                role: document.getElementById('u-role').value,
                strikes: [],
                joinedDate: new Date().toLocaleDateString()
            };
            if(!data.firstName || !data.username || !data.password) return alert("Required: First Name, Username, and Password");
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), data);
            closeModal();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const target = document.getElementById(`tab-${tab}`);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('active-tab', b.dataset.tab === tab);
            });
        };
        window.showModal = (html) => { document.getElementById('modal-content').innerHTML = html; document.getElementById('modal-container').classList.remove('hidden'); };
        window.closeModal = () => document.getElementById('modal-container').classList.add('hidden');
        window.logout = () => { localStorage.removeItem('wf_staff_session'); location.reload(); };

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!authReady) return alert("System connecting...");
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === 'admin' && p === 'setup123') {
                const session = { username: 'Super Admin', role: 'admin', uid: 'initial-admin' };
                localStorage.setItem('wf_staff_session', JSON.stringify(session));
                applySession(session);
                return;
            }
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            let found = false;
            snap.forEach(d => {
                const data = d.data();
                if (data.username === u && data.password === p) {
                    found = true;
                    const session = { ...data, uid: d.id };
                    localStorage.setItem('wf_staff_session', JSON.stringify(session));
                    applySession(session);
                }
            });
            if (!found) alert("Incorrect credentials.");
        };

        const todayInput = document.getElementById('attendance-date');
        if(todayInput) {
            todayInput.valueAsDate = new Date();
            todayInput.onchange = renderRoster;
        }
    </script>
</body>
</html>
